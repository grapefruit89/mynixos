# meta:
#   owner: core
#   status: active
#   scope: shared
#   summary: Boot-Partition Safeguard â€“ Verhindert Overflow durch aggressive GC
#   priority: P0 (Blocker)
#   issue: Boot-Partition nur 96MB, fÃ¼llt sich bei ~6 Generationen

{ config, lib, pkgs, ... }:

let
  # Schwellwerte fÃ¼r Warnungen
  warningThreshold = 75;  # % FÃ¼llstand
  criticalThreshold = 85; # % FÃ¼llstand
  
  # Space-Check Script
  bootSpaceCheck = pkgs.writeShellScriptBin "boot-space-check" ''
    #!/usr/bin/env bash
    set -euo pipefail
    
    # Farben fÃ¼r Terminal-Output
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    GREEN='\033[0;32m'
    NC='\033[0m' # No Color
    
    # Boot-Partition FÃ¼llstand ermitteln
    BOOT_USAGE=$(df /boot | tail -1 | awk '{print $5}' | sed 's/%//')
    BOOT_AVAIL=$(df -h /boot | tail -1 | awk '{print $4}')
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ” Boot-Partition Status"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # Status-Anzeige mit Farben
    if [ "$BOOT_USAGE" -ge ${toString criticalThreshold} ]; then
      echo -e "Status:   ''${RED}KRITISCH''${NC} (''${BOOT_USAGE}%)"
      echo -e "Frei:     ''${RED}''${BOOT_AVAIL}''${NC}"
      echo ""
      echo "ğŸš¨ AKTION ERFORDERLICH:"
      echo "   sudo nix-collect-garbage --delete-older-than 3d"
      echo "   sudo nixos-rebuild switch --rollback"
      EXIT_CODE=2
    elif [ "$BOOT_USAGE" -ge ${toString warningThreshold} ]; then
      echo -e "Status:   ''${YELLOW}WARNUNG''${NC} (''${BOOT_USAGE}%)"
      echo -e "Frei:     ''${YELLOW}''${BOOT_AVAIL}''${NC}"
      echo ""
      echo "âš ï¸  Empfehlung: Alte Generationen lÃ¶schen"
      echo "   nclean (oder: sudo nix-collect-garbage)"
      EXIT_CODE=1
    else
      echo -e "Status:   ''${GREEN}OK''${NC} (''${BOOT_USAGE}%)"
      echo -e "Frei:     ''${GREEN}''${BOOT_AVAIL}''${NC}"
      EXIT_CODE=0
    fi
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # Generationen auflisten
    echo ""
    echo "ğŸ“¦ Installierte Generationen:"
    sudo nix-env -p /nix/var/nix/profiles/system --list-generations | tail -6
    
    exit $EXIT_CODE
  '';
  
  # Pre-Build Hook (verhindert Build bei vollem /boot)
  preBuildCheck = pkgs.writeShellScriptBin "pre-build-check" ''
    #!/usr/bin/env bash
    set -euo pipefail
    
    BOOT_USAGE=$(df /boot | tail -1 | awk '{print $5}' | sed 's/%//')
    
    if [ "$BOOT_USAGE" -ge ${toString criticalThreshold} ]; then
      echo "âŒ FEHLER: /boot ist zu ''${BOOT_USAGE}% voll!"
      echo ""
      echo "nixos-rebuild wurde abgebrochen, um ein volles /boot zu verhindern."
      echo ""
      echo "LÃ¶sung:"
      echo "  1. sudo nix-collect-garbage --delete-older-than 3d"
      echo "  2. sudo nixos-rebuild boot  (keine neue Generation auf /boot)"
      echo "  3. sudo reboot"
      echo "  4. Dann: sudo nix-collect-garbage -d  (lÃ¶scht alte boot-EintrÃ¤ge)"
      echo ""
      exit 1
    fi
    
    echo "âœ… /boot Check: OK (''${BOOT_USAGE}%)"
  '';
  
  # Emergency Cleanup Script
  emergencyCleanup = pkgs.writeShellScriptBin "boot-emergency-cleanup" ''
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "ğŸš¨ NOTFALL-CLEANUP fÃ¼r /boot"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    # Aktuelle Generationen anzeigen
    echo "Vorher:"
    sudo nix-env -p /nix/var/nix/profiles/system --list-generations
    echo ""
    
    # Nur die letzten 3 Generationen behalten
    read -p "Alle auÃŸer den letzten 3 Generationen lÃ¶schen? [y/N]: " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      sudo nix-env -p /nix/var/nix/profiles/system --delete-generations +3
      sudo nix-collect-garbage -d
      
      echo ""
      echo "Nachher:"
      sudo nix-env -p /nix/var/nix/profiles/system --list-generations
      
      echo ""
      echo "âœ… Cleanup abgeschlossen"
      echo "   Neuer /boot FÃ¼llstand:"
      df -h /boot | tail -1
    else
      echo "Abgebrochen."
    fi
  '';
in
{
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # KONFIGURATION: Aggressive GC + Generation-Limit
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # Automatische Garbage Collection (TÃ„GLICH statt wÃ¶chentlich)
  nix.gc = {
    automatic = true;
    dates = "daily";  # Vorher: "Sun 03:30" (nur 1x pro Woche)
    options = "--delete-older-than 7d";  # Vorher: 14d
    persistent = true;
  };
  
  # Optimierung nach GC (Deduplizierung)
  nix.optimise = {
    automatic = true;
    dates = [ "weekly" ];  # 1x pro Woche reicht
  };
  
  # Maximale Anzahl Generationen auf /boot (KRITISCH!)
  boot.loader.systemd-boot.configurationLimit = 5;
  # ^ LÃ¶scht automatisch alte boot-EintrÃ¤ge wenn Limit erreicht
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SYSTEMD SERVICES: Monitoring & Pre-Build Check
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # Service: TÃ¤glich Boot-Partition checken
  systemd.services.boot-space-monitor = {
    description = "Boot Partition Space Monitor";
    serviceConfig = {
      Type = "oneshot";
      ExecStart = "${bootSpaceCheck}/bin/boot-space-check";
      # Bei kritischem Zustand: Alert per Journal
      StandardOutput = "journal";
      StandardError = "journal";
    };
  };
  
  # Timer: TÃ¤glich um 08:00 prÃ¼fen
  systemd.timers.boot-space-monitor = {
    wantedBy = [ "timers.target" ];
    timerConfig = {
      OnCalendar = "daily";
      OnBootSec = "5min";  # Auch 5min nach Boot prÃ¼fen
      Persistent = true;
    };
  };
  
  # Service: Pre-Build Check (lÃ¤uft VOR nixos-rebuild)
  # HINWEIS: Dieser Service wird manuell via Alias aufgerufen
  systemd.services.pre-build-check = {
    description = "Pre-Build Boot Space Check";
    serviceConfig = {
      Type = "oneshot";
      ExecStart = "${preBuildCheck}/bin/pre-build-check";
    };
  };
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SHELL INTEGRATION: Warnungen + Helper
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # Alias fÃ¼r manuellen Check
  programs.bash.shellAliases = {
    boot-check = "${bootSpaceCheck}/bin/boot-space-check";
    boot-emergency = "${emergencyCleanup}/bin/boot-emergency-cleanup";
  };
  
  # Helper-Scripts systemweit verfÃ¼gbar machen
  environment.systemPackages = [
    bootSpaceCheck
    preBuildCheck
    emergencyCleanup
  ];
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ERWEITERTE NIX-EINSTELLUNGEN
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  nix.settings = {
    # Automatisch tote Symlinks entfernen
    auto-optimise-store = true;
    
    # Maximal genutzte Cores beim Build (verhindert OOM)
    max-jobs = lib.mkDefault 2;
    cores = lib.mkDefault 2;
    
    # Warnings bei vollem Store
    warn-dirty = true;
  };
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # WRAPPER: nixos-rebuild mit Pre-Check
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # Ersetze 'nixos-rebuild' mit sicherem Wrapper
  environment.systemPackages = [
    (pkgs.writeShellScriptBin "nixos-rebuild-safe" ''
      #!/usr/bin/env bash
      set -euo pipefail
      
      # Pre-Build Check
      if ! ${preBuildCheck}/bin/pre-build-check; then
        echo ""
        echo "Abbruch durch boot-space-check."
        exit 1
      fi
      
      # Original nixos-rebuild aufrufen
      exec ${pkgs.nixos-rebuild}/bin/nixos-rebuild "$@"
    '')
  ];
  
  # Alias: 'nsw-safe' statt 'nsw'
  programs.bash.shellAliases = {
    nsw-safe = "sudo nixos-rebuild-safe switch";
    ntest-safe = "sudo nixos-rebuild-safe test";
  };
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ASSERTIONS: SicherheitsprÃ¼fungen
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  assertions = [
    {
      assertion = config.boot.loader.systemd-boot.configurationLimit <= 10;
      message = "boot-safeguard: configurationLimit sollte <= 10 sein (aktuell: ${toString config.boot.loader.systemd-boot.configurationLimit})";
    }
    {
      assertion = config.nix.gc.automatic == true;
      message = "boot-safeguard: nix.gc.automatic muss aktiviert sein!";
    }
  ];
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DOKUMENTATION: In-Code Hinweise
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # Warnung im System-Log bei Boot
  systemd.services.boot-safeguard-info = {
    description = "Boot Safeguard Info Message";
    wantedBy = [ "multi-user.target" ];
    after = [ "network.target" ];
    serviceConfig = {
      Type = "oneshot";
      RemainAfterExit = true;
    };
    script = ''
      ${pkgs.coreutils}/bin/cat <<'EOF' | ${pkgs.util-linux}/bin/logger -t boot-safeguard
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘  BOOT-SAFEGUARD AKTIV                                          â•‘
      â•‘  - Maximale Generationen: ${toString config.boot.loader.systemd-boot.configurationLimit}                                         â•‘
      â•‘  - GC-Intervall: tÃ¤glich                                       â•‘
      â•‘  - Monitor: systemctl status boot-space-monitor                â•‘
      â•‘  - Manueller Check: boot-check                                 â•‘
      â•‘  - Notfall-Cleanup: boot-emergency                             â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      EOF
    '';
  };
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# USAGE GUIDE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# MANUELLER CHECK:
#   $ boot-check
#   Status:   OK (67%)
#   Frei:     31M
#
# NOTFALL-CLEANUP (wenn /boot >90% voll):
#   $ boot-emergency
#   (LÃ¶scht alle auÃŸer den letzten 3 Generationen)
#
# SICHERE REBUILDS:
#   $ nsw-safe    # Statt 'nsw'
#   (PrÃ¼ft vorher ob /boot voll ist)
#
# MONITORING:
#   $ systemctl status boot-space-monitor
#   $ journalctl -u boot-space-monitor -f
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
