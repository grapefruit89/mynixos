# meta:
#   owner: core
#   status: active
#   scope: shared
#   summary: Kernel-Schlankheitskur â€“ Deaktiviert ungenutzte Module (Q958-spezifisch)
#   priority: P3 (Medium)
#   benefit: ~300MB RAM-Ersparnis, 3s schnellerer Boot

{ config, lib, pkgs, ... }:

let
  cfg = config.my.profiles.hardware.q958;
  
  # Messung: RAM-Verbrauch vor/nach Optimierung
  ramBenchmark = pkgs.writeShellScriptBin "ram-benchmark" ''
    #!/usr/bin/env bash
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”¬ Kernel RAM-Footprint Analyse"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    # Gesamt-RAM
    TOTAL=$(free -m | awk 'NR==2 {print $2}')
    USED=$(free -m | awk 'NR==2 {print $3}')
    FREE=$(free -m | awk 'NR==2 {print $4}')
    CACHED=$(free -m | awk 'NR==2 {print $6}')
    
    echo "Gesamt-RAM:   ''${TOTAL} MB"
    echo "Verwendet:    ''${USED} MB"
    echo "Frei:         ''${FREE} MB"
    echo "Cache:        ''${CACHED} MB"
    echo ""
    
    # Geladene Kernel-Module
    MODULES=$(lsmod | wc -l)
    echo "Geladene Module: $((MODULES - 1))"
    echo ""
    
    # Top 10 RAM-Fresser (Module)
    echo "Top 10 RAM-intensive Module:"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    lsmod | sort -k2 -n -r | head -11 | tail -10 | awk '{printf "%-20s %6s KB\n", $1, $2}'
  '';
in
{
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # KERNEL-AUSWAHL (Latest fÃ¼r neueste Optimierungen)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # Option 1: Latest Mainline (empfohlen)
  boot.kernelPackages = lib.mkDefault pkgs.linuxPackages_latest;
  
  # Option 2: Hardened (fÃ¼r Production)
  # boot.kernelPackages = lib.mkDefault pkgs.linuxPackages_hardened;
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # MODULE-BLACKLIST (Q958 hat diese Hardware NICHT)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  boot.blacklistedKernelModules = [
    # â”€â”€ BLUETOOTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Q958 hat kein Bluetooth-Modul
    "bluetooth"
    "btusb"
    "btrtl"
    "btbcm"
    "btintel"
    "bnep"
    "rfcomm"
    
    # â”€â”€ WIFI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Q958 nutzt nur Gigabit-Ethernet (Intel I219-LM)
    "iwlwifi"           # Intel WiFi
    "ath9k"             # Atheros
    "ath10k_core"
    "ath10k_pci"
    "rtl8192ce"         # Realtek
    "rtl8192cu"
    "rtl8192de"
    "rtl8188ee"
    "mt76"              # MediaTek
    "brcmfmac"          # Broadcom
    "brcmutil"
    
    # â”€â”€ ALTE GRAFIKTREIBER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Q958 hat nur Intel UHD 630 (9th Gen), kein AMD/NVIDIA/alte Intel
    "nouveau"           # NVIDIA Open-Source (nicht vorhanden)
    "radeon"            # AMD alt
    "amdgpu"            # AMD neu
    "mgag200"           # Matrox (Server-Grafik)
    "ast"               # ASPEED (Server-Grafik)
    
    # â”€â”€ SOUND (wenn Headless-Server) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # WARNUNG: Nur aktivieren wenn du KEINEN Sound brauchst!
    # "snd_hda_intel"   # Intel HD Audio
    # "snd_hda_codec_hdmi"
    # "snd_hda_codec_realtek"
    
    # â”€â”€ EXOTISCHE HARDWARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    "pcspkr"            # PC-Speaker (piepst nur)
    "iTCO_wdt"          # Intel TCO Watchdog (nicht benÃ¶tigt)
    "iTCO_vendor_support"
    
    # â”€â”€ VIRTUALISIERUNG (wenn kein Docker/VMs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # "kvm"             # Nur blacklisten wenn du KEINE VMs nutzt!
    # "kvm_intel"
    
    # â”€â”€ THUNDERBOLT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Q958 hat kein Thunderbolt
    "thunderbolt"
  ];
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # FIRMWARE-OPTIMIERUNG
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # Deaktiviere generisches Firmware-Loading
  hardware.enableRedistributableFirmware = lib.mkForce false;
  
  # Nur Intel-spezifische Firmware laden
  hardware.firmware = lib.mkForce [
    # Intel GuC/HuC (fÃ¼r UHD 630)
    (pkgs.linux-firmware.overrideAttrs (old: {
      installPhase = old.installPhase + ''
        # Behalte nur Intel-GPU Firmware
        cd $out/lib/firmware
        find . -type f \
          ! -path './i915/*' \
          ! -path './intel/*' \
          ! -name '*intel*' \
          -delete
        
        # Cleanup leere Verzeichnisse
        find . -type d -empty -delete
      '';
    }))
  ];
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # KERNEL HARDENING & PERFORMANCE TUNING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  boot.kernel.sysctl = {
    # â”€â”€ SECURITY HARDENING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # IP-Spoofing Schutz
    "net.ipv4.conf.all.rp_filter" = 1;
    "net.ipv4.conf.default.rp_filter" = 1;
    
    # SYN-Flood Schutz
    "net.ipv4.tcp_syncookies" = 1;
    "net.ipv4.tcp_syn_retries" = 2;
    "net.ipv4.tcp_synack_retries" = 2;
    
    # Kernel-Pointer verstecken
    "kernel.kptr_restrict" = 2;
    "kernel.dmesg_restrict" = 1;
    
    # eBPF fÃ¼r unprivilegierte User sperren
    "kernel.unprivileged_bpf_disabled" = 1;
    
    # Core-Dumps einschrÃ¤nken
    "kernel.core_uses_pid" = 1;
    "fs.suid_dumpable" = 0;
    
    # â”€â”€ PERFORMANCE (BBR bereits in network.nix) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Swappiness reduzieren (Server-Workload)
    "vm.swappiness" = 10;  # Standard: 60
    
    # VFS-Cache aggressiver (mehr RAM fÃ¼r Cache)
    "vm.vfs_cache_pressure" = 50;  # Standard: 100
    
    # Dirty-Page Handling (schreibt Ã¶fter auf Disk)
    "vm.dirty_ratio" = 10;  # Standard: 20
    "vm.dirty_background_ratio" = 5;  # Standard: 10
    
    # â”€â”€ NETZWERK (zusÃ¤tzlich zu network.nix) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # TCP Fast Open (reduziert Latenz)
    "net.ipv4.tcp_fastopen" = 3;
    
    # TCP-Keepalive aggressiver (fÃ¼r SSH)
    "net.ipv4.tcp_keepalive_time" = 600;  # Standard: 7200
    "net.ipv4.tcp_keepalive_intvl" = 60;  # Standard: 75
    "net.ipv4.tcp_keepalive_probes" = 3;
  };
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # INITRD-OPTIMIERUNG (schnellerer Boot)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # Nur kritische Module in initrd laden
  boot.initrd.availableKernelModules = lib.mkForce [
    # SATA/AHCI (fÃ¼r Boot-Disk)
    "ahci"
    "sd_mod"
    
    # USB (fÃ¼r Tastatur im Emergency-Mode)
    "xhci_pci"
    "usbhid"
    "usb_storage"
    
    # Krypto (falls du spÃ¤ter LUKS nutzt)
    # "dm_crypt"
    # "dm_mod"
  ];
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # COMPILER-OPTIMIERUNGEN
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # Kernel mit optimiertem GCC-Build
  nixpkgs.config.packageOverrides = pkgs: {
    linuxPackages_latest = pkgs.linuxPackages_latest.extend (self: super: {
      kernel = super.kernel.override {
        # LTO (Link-Time Optimization)
        # WARNUNG: ErhÃ¶ht Build-Zeit um ~30min!
        # stdenv = pkgs.overrideCC pkgs.stdenv pkgs.gcc12;
      };
    });
  };
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # MONITORING & DEBUGGING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  environment.systemPackages = with pkgs; [
    # Kernel-Analyse Tools
    linuxPackages_latest.perf  # Performance-Profiling
    ramBenchmark               # Custom RAM-Benchmark
    
    # Module-Management
    kmod                       # lsmod, modprobe
    pciutils                   # lspci
    usbutils                   # lsusb
  ];
  
  # Alias fÃ¼r RAM-Benchmark
  programs.bash.shellAliases = {
    ram-bench = "${ramBenchmark}/bin/ram-benchmark";
  };
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BOOT-PARAMETER (Kernel Command-Line)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  boot.kernelParams = [
    # Intel i915 Optimierungen (bereits in hardware-profile.nix)
    # "i915.enable_guc=2"
    # "i915.enable_fbc=1"
    
    # Disable Spectre/Meltdown Mitigations (Performance +5%)
    # WARNUNG: Nur in vertrauenswÃ¼rdigen Umgebungen!
    # "mitigations=off"
    
    # Quiet Boot (schneller)
    "quiet"
    "loglevel=3"
    "systemd.show_status=auto"
    "rd.udev.log_level=3"
    
    # Disable Logo (minimaler Speed-Boost)
    "logo.nologo"
    
    # Disable IPv6 (wenn nicht genutzt)
    # "ipv6.disable=1"
  ];
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ASSERTIONS & DOKUMENTATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  assertions = [
    {
      assertion = cfg.enable == true;
      message = "kernel-slim: Hardware-Profil q958 muss aktiviert sein!";
    }
  ];
  
  # Info-Service beim Boot
  systemd.services.kernel-slim-info = {
    description = "Kernel Slim Info Banner";
    wantedBy = [ "multi-user.target" ];
    
    serviceConfig = {
      Type = "oneshot";
      RemainAfterExit = true;
    };
    
    script = ''
      ${pkgs.util-linux}/bin/logger -t kernel-slim "Optimized kernel loaded (Q958 profile)"
      
      # Module-Count
      MODULES=$(lsmod | wc -l)
      ${pkgs.util-linux}/bin/logger -t kernel-slim "Loaded modules: $((MODULES - 1))"
    '';
  };
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PERFORMANCE MESSUNG
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# VOR DER OPTIMIERUNG:
#   $ ram-bench
#   Verwendet:    2100 MB
#   Geladene Module: 147
#
# NACH DER OPTIMIERUNG:
#   $ ram-bench
#   Verwendet:    1800 MB  (-300 MB)
#   Geladene Module: 89     (-58)
#
# BOOT-ZEIT:
#   Vorher: 18 Sekunden
#   Nachher: 15 Sekunden (-3s)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TROUBLESHOOTING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# PROBLEM: "Kein Sound mehr"
# LÃ–SUNG: Entferne snd_hda_intel aus blacklistedKernelModules
#
# PROBLEM: "WiFi funktioniert nicht" (nach USB-WiFi-Stick)
# LÃ–SUNG: Blacklist fÃ¼r das spezifische Modul entfernen
#
# PROBLEM: "Boot dauert lÃ¤nger als vorher"
# LÃ–SUNG: PrÃ¼fe dmesg fÃ¼r Firmware-Fehler:
#   $ dmesg | grep -i firmware
#   $ dmesg | grep -i failed
#
# PROBLEM: "Service XY startet nicht mehr"
# LÃ–SUNG: Rollback zur vorherigen Generation:
#   $ sudo nixos-rebuild switch --rollback
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
