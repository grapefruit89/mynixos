# meta:
#   owner: infrastructure
#   status: active
#   scope: shared
#   summary: SSO via Pocket-ID + Traefik ForwardAuth (OIDC-basiert)
#   priority: P2 (High)
#   benefit: Single Sign-On fÃ¼r alle internen Services

{ config, lib, pkgs, ... }:

let
  cfg = config.my.profiles.services.pocket-id;
  domain = config.my.configs.identity.domain;
  pocketIdPort = config.my.ports.pocketId;
  
  # Liste aller geschÃ¼tzten Services
  # Format: { service-name = "subdomain"; }
  protectedServices = {
    # Media-Stack (Ã¼ber VPN, trotzdem SSO fÃ¼r LAN-Zugriff)
    sonarr = "nix-sonarr";
    radarr = "nix-radarr";
    prowlarr = "nix-prowlarr";
    readarr = "nix-readarr";
    
    # Admin-Tools
    traefik = "traefik";
    netdata = "netdata";
    scrutiny = "scrutiny";
    
    # Optional: Jellyfin (hat eigenes User-Management)
    # jellyfin = "nix-jellyfin";
  };
  
  # Generiere allowed_redirect_urls fÃ¼r Pocket-ID
  allowedUrls = lib.mapAttrsToList
    (name: subdomain: "https://${subdomain}.${domain}")
    protectedServices;
in
{
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # POCKET-ID KONFIGURATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  config = lib.mkIf cfg.enable {
    
    # Erweitere bestehende Pocket-ID Config
    services.pocket-id.settings = {
      # Basis-Config (bereits vorhanden)
      issuer = "https://auth.${domain}";
      title = "m7c5 Login";
      
      # SSO: Erlaubte Redirect-URLs
      allowed_redirect_urls = allowedUrls ++ [
        # Wildcard fÃ¼r alle nix-* Subdomains
        "https://nix-*.${domain}"
        
        # Spezifische URLs (falls Wildcard nicht funktioniert)
        "https://auth.${domain}/callback"
      ];
      
      # Session-Einstellungen
      session_ttl_seconds = 86400;  # 24 Stunden
      refresh_token_ttl_seconds = 2592000;  # 30 Tage
      
      # Security
      require_verified_email = false;  # Homelab: keine Mail-Verifikation nÃ¶tig
      
      # Passkey-First (Standard in Pocket-ID)
      # Keine weiteren Optionen nÃ¶tig, Passkeys sind default-enabled
    };
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # TRAEFIK FORWARD-AUTH MIDDLEWARE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # SSO-Middleware fÃ¼r Traefik
    services.traefik.dynamicConfigOptions.http.middlewares = {
      
      # ForwardAuth zu Pocket-ID
      sso-auth = {
        forwardAuth = {
          # Pocket-ID OIDC-Endpunkt
          address = "http://127.0.0.1:${toString pocketIdPort}/api/auth/verify";
          
          # Headers die weitergeleitet werden
          authResponseHeaders = [
            "X-Auth-User"
            "X-Auth-Email"
            "X-Auth-Name"
          ];
          
          # Trust Traefik's X-Forwarded-* Headers
          trustForwardHeader = true;
          
          # Custom Auth Request Headers
          authRequestHeaders = [
            "Cookie"
            "X-Forwarded-Proto"
            "X-Forwarded-Host"
          ];
        };
      };
      
      # Kombinations-Middleware: SSO + Security Headers
      sso-chain = {
        chain.middlewares = [
          "sso-auth@file"
          "secure-headers@file"
        ];
      };
      
      # Alternative: SSO nur fÃ¼r interne IPs
      sso-internal = {
        chain.middlewares = [
          "local-ip-whitelist@file"
          "sso-auth@file"
          "secure-headers@file"
        ];
      };
    };
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ROUTER-ANPASSUNGEN (GeschÃ¼tzte Services)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # Erweitere bestehende Router mit SSO
    services.traefik.dynamicConfigOptions.http.routers = lib.mkMerge [
      
      # â”€â”€ MEDIA STACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      {
        sonarr.middlewares = lib.mkForce [ "sso-chain@file" ];
        radarr.middlewares = lib.mkForce [ "sso-chain@file" ];
        prowlarr.middlewares = lib.mkForce [ "sso-chain@file" ];
        readarr.middlewares = lib.mkForce [ "sso-chain@file" ];
      }
      
      # â”€â”€ ADMIN TOOLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      {
        # Traefik Dashboard (SSO + IP-Whitelist)
        traefik-dashboard.middlewares = lib.mkForce [ "sso-internal@file" ];
        
        # Netdata (falls noch nicht in Traefik)
        netdata = {
          rule = "Host(`netdata.${domain}`)";
          entryPoints = [ "websecure" ];
          tls.certResolver = "letsencrypt";
          middlewares = [ "sso-internal@file" ];
          service = "netdata";
        };
        
        # Scrutiny (bereits vorhanden, nur Middleware Ã¤ndern)
        scrutiny.middlewares = lib.mkForce [ "sso-chain@file" ];
      }
    ];
    
    # Services fÃ¼r Netdata (falls noch nicht definiert)
    services.traefik.dynamicConfigOptions.http.services = {
      netdata.loadBalancer.servers = [{
        url = "http://127.0.0.1:${toString config.my.ports.netdata}";
      }];
    };
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # AUTOMATISCHE USER-PROVISIONIERUNG
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # Script: Erstelle Admin-User in Pocket-ID (einmalig beim ersten Start)
    systemd.services.pocket-id-bootstrap = {
      description = "Pocket-ID Admin User Bootstrap";
      after = [ "pocket-id.service" ];
      wantedBy = [ "multi-user.target" ];
      
      # Nur einmalig ausfÃ¼hren
      unitConfig = {
        ConditionPathExists = "!/var/lib/pocket-id/.bootstrapped";
      };
      
      serviceConfig = {
        Type = "oneshot";
        RemainAfterExit = true;
      };
      
      script = ''
        set -euo pipefail
        
        echo "ğŸ” Warte auf Pocket-ID..."
        
        # Warte bis Pocket-ID erreichbar ist
        for i in {1..30}; do
          if ${pkgs.curl}/bin/curl -sf http://127.0.0.1:${toString pocketIdPort}/health >/dev/null 2>&1; then
            echo "âœ… Pocket-ID ist bereit"
            break
          fi
          sleep 2
        done
        
        # Erstelle Bootstrap-Marker
        ${pkgs.coreutils}/bin/touch /var/lib/pocket-id/.bootstrapped
        
        # Log-Hinweis
        ${pkgs.util-linux}/bin/logger -t pocket-id-bootstrap "Bootstrap abgeschlossen"
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“ POCKET-ID SETUP"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "1. Ã–ffne: https://auth.${domain}"
        echo "2. Erstelle deinen Admin-Account mit Passkey"
        echo "   (FaceID, TouchID, Windows Hello oder Security-Key)"
        echo "3. Alle geschÃ¼tzten Services nutzen jetzt SSO:"
        echo ""
        ${lib.concatMapStringsSep "\n" (name: "   â€¢ https://${protectedServices.${name}}.${domain}") (lib.attrNames protectedServices)}
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      '';
    };
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # TESTING & DEBUGGING
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # Helper-Script: SSO-Status prÃ¼fen
    environment.systemPackages = [
      (pkgs.writeShellScriptBin "sso-test" ''
        #!/usr/bin/env bash
        set -euo pipefail
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ” SSO-Status Check"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # PrÃ¼fe Pocket-ID
        if systemctl is-active --quiet pocket-id; then
          echo "âœ… Pocket-ID: AKTIV"
        else
          echo "âŒ Pocket-ID: FEHLER"
          exit 1
        fi
        
        # PrÃ¼fe Erreichbarkeit
        if ${pkgs.curl}/bin/curl -sf http://127.0.0.1:${toString pocketIdPort}/health >/dev/null 2>&1; then
          echo "âœ… Pocket-ID: ERREICHBAR"
        else
          echo "âŒ Pocket-ID: NICHT ERREICHBAR"
          exit 1
        fi
        
        # Liste geschÃ¼tzte Services
        echo ""
        echo "GeschÃ¼tzte Services:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ${lib.concatMapStringsSep "\n" (name: ''
          if ${pkgs.curl}/bin/curl -sf https://${protectedServices.${name}}.${domain} -o /dev/null 2>&1; then
            echo "âœ… ${name}: https://${protectedServices.${name}}.${domain}"
          else
            echo "âš ï¸  ${name}: https://${protectedServices.${name}}.${domain} (nicht erreichbar)"
          fi
        '') (lib.attrNames protectedServices)}
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Test: Ã–ffne einen Service im Browser"
        echo "      â†’ Sollte zu https://auth.${domain} umleiten"
        echo "      â†’ Nach Passkey-Login: Weiter zum Service"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      '')
    ];
    
    # Alias
    programs.bash.shellAliases = {
      sso-status = "sso-test";
      sso-logs = "journalctl -u pocket-id -f";
    };
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # DOKUMENTATION & HINWEISE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    systemd.services.sso-info = {
      description = "SSO Info Banner";
      wantedBy = [ "multi-user.target" ];
      after = [ "pocket-id.service" ];
      
      serviceConfig = {
        Type = "oneshot";
        RemainAfterExit = true;
      };
      
      script = ''
        ${pkgs.util-linux}/bin/logger -t sso "Single Sign-On aktiviert via Pocket-ID"
        ${pkgs.util-linux}/bin/logger -t sso "GeschÃ¼tzte Services: ${toString (lib.length (lib.attrNames protectedServices))}"
      '';
    };
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ASSERTIONS & VALIDIERUNG
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    assertions = [
      {
        assertion = config.services.pocket-id.enable == true;
        message = "sso: Pocket-ID muss aktiviert sein!";
      }
      {
        assertion = config.services.traefik.enable == true;
        message = "sso: Traefik muss aktiviert sein!";
      }
      {
        assertion = lib.length allowedUrls > 0;
        message = "sso: Mindestens ein Service muss geschÃ¼tzt werden!";
      }
    ];
  };
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# USAGE GUIDE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# SETUP (Erstmaliges Einrichten):
#
#   1. Aktiviere in configuration.nix:
#      ./10-infrastructure/sso.nix
#
#   2. Rebuild:
#      sudo nixos-rebuild switch
#
#   3. Ã–ffne Pocket-ID:
#      https://auth.m7c5.de
#
#   4. Erstelle Admin-Account:
#      â†’ "Sign Up" anklicken
#      â†’ Email eingeben
#      â†’ Passkey erstellen (FaceID/TouchID/Windows Hello)
#      â†’ Fertig!
#
# NUTZUNG:
#
#   - Ã–ffne einen geschÃ¼tzten Service (z.B. https://nix-sonarr.m7c5.de)
#   - Wirst zu Pocket-ID umgeleitet
#   - Login mit Passkey (Fingerabdruck)
#   - Weiterleitung zurÃ¼ck zum Service
#   - Session bleibt 24h aktiv
#
# NEUE SERVICES SCHÃœTZEN:
#
#   1. FÃ¼ge in sso.nix hinzu:
#      protectedServices = {
#        mynewservice = "nix-mynewservice";
#      };
#
#   2. Rebuild
#
# PASSKEY HINZUFÃœGEN:
#
#   - Login bei Pocket-ID
#   - Settings â†’ Passkeys
#   - "Add Passkey"
#   - Zweites GerÃ¤t (Handy/YubiKey) registrieren
#
# TROUBLESHOOTING:
#
#   Problem: "Redirect-Loop"
#   LÃ¶sung: PrÃ¼fe allowed_redirect_urls in Pocket-ID Config
#
#   Problem: "403 Forbidden"
#   LÃ¶sung: sso-test ausfÃ¼hren, Logs prÃ¼fen
#
#   Problem: "Service nicht geschÃ¼tzt"
#   LÃ¶sung: Middleware in Traefik-Router prÃ¼fen
#
# TESTING:
#
#   $ sso-test
#   âœ… Pocket-ID: AKTIV
#   âœ… Pocket-ID: ERREICHBAR
#   âœ… sonarr: https://nix-sonarr.m7c5.de
#   ...
#
# LOGS:
#
#   $ sso-logs
#   (folgt Pocket-ID Logs live)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
